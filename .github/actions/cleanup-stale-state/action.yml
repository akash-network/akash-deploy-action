name: Cleanup stale state
description: Cleanup state .akash/project-name if deployment is inactive

inputs:
  password:
    description: 'Password to decrypt the wallet'
    required: true
    type: string
  project-path:
    description: 'Path to the project'
    required: true
    type: string
  project-name:
    description: 'Project name (will be used as prefix for state files)'
    required: false
    default: 'app'
    type: string

runs:
  using: "composite"

  steps:
  - name: Close stale deployment
    id: close-stale-deployment
    shell: bash
    run: |
      echo "Closing stale deployment"

      ## === broadcast tx === ##
      TX=$(echo "${{ inputs.password }}" | ${CLIENT} tx deployment close | jq -r '.txhash')
      if test -z $TX; then
        echo "No TX broadcasted!"
        exit 1
      fi
      echo "TX: $TX"
      sleep ${BLOCK_TIME}
      RC=$(${CLIENT} query tx $TX | jq -r '.code')
      case $RC in
        0)
          echo "TX successful"
          ;;
        11)
          echo "Out of gas! Consider raising AKASH_GAS_ADJUSTMENT and trying again."
          exit 1
          ;;
        *)
          echo "Transaction $TX failed with code: '$RC'"
          exit 1
          ;;
      esac
      ## === broadcast tx === ##

  - name: Remove the state if deployment is inactive
    id: remove-state
    shell: bash
    run: |
      echo "AKASH_DSEQ=" >> $GITHUB_ENV
      echo "AKASH_PROVIDER=" >> $GITHUB_ENV
      rm -vrf ${{ inputs.project-path }}/.akash/${{ inputs.project-name }}

